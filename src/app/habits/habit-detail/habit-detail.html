<div class="container mx-auto p-6 max-w-4xl">
  <!-- Loading State -->
  @if (isLoading) {
  <div class="text-center py-16">
    <div
      class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-600"
    ></div>
    <p class="mt-4 text-gray-600">Loading habit details...</p>
  </div>
  }

  <!-- Error Message -->
  @if (errorMessage) {
  <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
    {{ errorMessage }}
  </div>
  }

  <!-- Success Message -->
  @if (successMessage) {
  <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-6">
    {{ successMessage }}
  </div>
  }

  <!-- Habit Details -->
  @if (habit && !isLoading) {
  <div class="bg-white rounded-lg shadow-md p-6">
    <!-- Header -->
    <div class="flex items-start justify-between mb-6">
      <div class="flex items-center">
        <div
          class="w-8 h-8 rounded-full mr-3"
          [style.backgroundColor]="habit.color || '#4caf50'"
        ></div>
        <div>
          <h1 class="text-2xl font-bold text-gray-800">{{ habit.title }}</h1>
          <p class="text-gray-600">{{ getFrequencyDisplay() }}</p>
        </div>
      </div>
      <div class="flex space-x-2">
        <button
          [routerLink]="['/habits', habit._id, 'edit']"
          class="bg-blue-100 text-blue-700 px-4 py-2 rounded hover:bg-blue-200 transition"
        >
          ‚úèÔ∏è Edit
        </button>
        <button
          routerLink="/habits"
          class="bg-gray-100 text-gray-700 px-4 py-2 rounded hover:bg-gray-200 transition"
        >
          ‚Üê Back
        </button>
      </div>
    </div>

    <!-- Description -->
    @if (habit.description) {
    <p class="text-gray-600 mb-6 p-4 bg-gray-50 rounded">
      {{ habit.description }}
    </p>
    }

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-blue-50 p-4 rounded text-center">
        <div class="text-2xl font-bold text-blue-600">{{ getProgressPercentage() }}%</div>
        <div class="text-sm text-blue-500">Completion Rate</div>
      </div>
      <div class="bg-green-50 p-4 rounded text-center">
        <div class="text-2xl font-bold text-green-600">{{ getCurrentStreak() }}</div>
        <div class="text-sm text-green-500">Current Streak</div>
      </div>
      <div class="bg-purple-50 p-4 rounded text-center">
        <div class="text-2xl font-bold text-purple-600">{{ getCompletedCount() }}</div>
        <div class="text-sm text-purple-500">Completed Days</div>
      </div>
      <div class="bg-orange-50 p-4 rounded text-center">
        <div class="text-2xl font-bold text-orange-600">{{ getTotalTrackedDays() }}</div>
        <div class="text-sm text-orange-500">Total Tracked</div>
      </div>
    </div>

    <!-- Progress Bar -->
    <div class="mb-6">
      <div class="flex justify-between text-sm mb-2">
        <span class="font-medium">Overall Progress</span>
        <span>{{ getProgressPercentage() }}%</span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-3">
        <div
          class="bg-blue-600 h-3 rounded-full transition-all duration-300"
          [style.width]="getProgressPercentage() + '%'"
        ></div>
      </div>
    </div>

    <!-- Today's Progress Section -->
    <div
      class="bg-gradient-to-r from-blue-50 to-green-50 p-6 rounded-lg mb-6 border border-blue-200"
    >
      <h3 class="font-semibold text-lg mb-4 text-gray-800">
        Today's Progress - {{ selectedDate | date : 'fullDate' }}
      </h3>

      <!-- Valid day for habit - show progress tracking -->
      @if (isTodayValidForHabit()) { @if (!isTodayCompleted()) {
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2 text-gray-700">Add a note (optional)</label>
          <textarea
            [(ngModel)]="note"
            placeholder="How did it go today? Any thoughts or reflections..."
            class="w-full border border-gray-300 p-3 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            rows="3"
          ></textarea>
        </div>
        <button
          (click)="markAsDone()"
          class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold"
        >
          ‚úÖ Mark as Completed
        </button>
      </div>
      } @else {
      <div class="bg-white p-4 rounded border border-green-200">
        <div class="flex items-center text-green-700">
          <span class="text-2xl mr-2">‚úÖ</span>
          <div>
            <p class="font-semibold">Habit completed for today!</p>
            @if (getTodaysNote()) {
            <p class="text-sm mt-1 text-gray-600">"{{ getTodaysNote() }}"</p>
            }
          </div>
        </div>
        <button
          (click)="markAsNotDone()"
          class="text-red-600 hover:text-red-800 text-sm mt-3 flex items-center"
        >
          <span class="mr-1">‚Ü∂</span> Undo completion
        </button>
      </div>
      } } @else {
      <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
        <div class="flex items-center text-yellow-700">
          <span class="text-xl mr-2">‚è∏Ô∏è</span>
          <div>
            <p class="font-semibold">Today is not a tracking day for this habit</p>
            <p class="text-sm mt-1">This habit is scheduled for: {{ getHabitSchedule() }}</p>
            <p class="text-sm mt-1">
              Next tracking day: {{ getNextValidDay() | date : 'fullDate' }}
            </p>
          </div>
        </div>
      </div>
      }
    </div>

    <!-- Progress History -->
    <div class="bg-white border border-gray-200 rounded-lg p-6">
      <h3 class="font-semibold text-lg mb-4 text-gray-800">Progress History</h3>

      @if (!habit.progress || habit.progress.length === 0) {
      <div class="text-center py-8 text-gray-500">
        <div class="text-4xl mb-2">üìä</div>
        <p>No progress recorded yet.</p>
        <p class="text-sm">Start tracking your habit to see your progress here!</p>
      </div>
      } @if (habit.progress && habit.progress.length > 0) {
      <div class="space-y-3 max-h-96 overflow-y-auto">
        @for (entry of habit.progress | slice:0:20; track entry.date) {
        <div
          class="flex items-center justify-between p-3 border-b border-gray-100 hover:bg-gray-50 rounded"
          [class.bg-green-50]="entry.done"
        >
          <div class="flex items-center">
            <span
              class="text-lg mr-3"
              [class.text-green-500]="entry.done"
              [class.text-red-400]="!entry.done"
            >
              {{ entry.done ? '‚úÖ' : '‚ùå' }}
            </span>
            <div>
              <span class="font-medium text-gray-800">{{ entry.date | date : 'mediumDate' }}</span>
              @if (entry.note) {
              <span class="block text-sm text-gray-600 mt-1">"{{ entry.note }}"</span>
              }
            </div>
          </div>
          <span
            class="text-sm font-medium"
            [class.text-green-600]="entry.done"
            [class.text-red-600]="!entry.done"
          >
            {{ entry.done ? 'Completed' : 'Skipped' }}
          </span>
        </div>
        }
      </div>
      } @if (habit.progress && habit.progress.length > 20) {
      <div class="text-center mt-4">
        <p class="text-sm text-gray-500">
          Showing latest 20 entries out of {{ habit.progress.length }}
        </p>
      </div>
      }
    </div>
  </div>
  }
</div>
